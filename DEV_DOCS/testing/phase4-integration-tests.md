# Phase 4: 集成测试 (L4 — Integration Tests)

> **预计工时:** 2 天 | **优先级:** P1/P2/P3 | **前置条件:** Phase
> 1-3 核心测试通过 **负责人:** \***\*\_\_\_\_\*\*** |
> **执行日期:** \***\*\_\_\_\_\*\***

---

## 测试目的

验证跨进程、跨语言组件间的通信和协作，覆盖 MCP
Server 连接、isQ 编译模拟、isqtools 调用链、自动修复、RAG 知识检索、LLM 集成及继承功能回归。

---

## 环境准备

- [ ] Phase 1-3 核心测试已通过
- [ ] Docker ≥ 24.x 已安装并运行
- [ ] Docker 镜像 `arclightquantum/isqc:ubuntu-0.0.1` 已拉取
- [ ] Docker 镜像 `isqc-python:latest` 已构建
- [ ] Qdrant 容器已启动 (`docker-compose up qdrant`)
- [ ] isQCodeAgent Python MCP Server 已配置
- [ ] `GEMINI_API_KEY` 和 `ZHIPU_API_KEY` 均已配置
- [ ] 测试数据文件已准备（见第 5 节）

---

## 4.4.1 MCP Server 连接 (P1)

| 编号  | 测试项              | 验证方法                             | 预期结果                                 | 状态 | 实际结果 | 备注 |
| ----- | ------------------- | ------------------------------------ | ---------------------------------------- | ---- | -------- | ---- |
| L4-01 | MCP Server 启动     | CLI 启动时自动拉起 Python MCP Server | 进程启动成功，stdio 通道建立             | 🔲   |          |      |
| L4-02 | Tool 列表发现       | CLI 向 MCP Server 请求 `tools/list`  | 返回 8 个工具定义（含名称、参数 schema） | 🔲   |          |      |
| L4-03 | MCP Server 异常恢复 | 杀死 MCP Server 进程后重新调用       | CLI 显示友好错误信息，支持重连或重试     | 🔲   |          |      |
| L4-04 | MCP Server 超时处理 | MCP Server 响应延迟超过阈值          | CLI 超时后给出提示，不阻塞主进程         | 🔲   |          |      |
| L4-05 | 多 MCP Server 共存  | 同时配置 isqcoder + 其他 MCP Server  | 互不干扰，工具名不冲突                   | 🔲   |          |      |

## 4.4.2 isQ 编译 & 模拟 (P1)

| 编号  | 测试项              | 验证方法                                 | 预期结果                                 | 状态 | 实际结果 | 备注 |
| ----- | ------------------- | ---------------------------------------- | ---------------------------------------- | ---- | -------- | ---- |
| L4-06 | 正确代码编译        | `isq_compile` 对 `bell_state.isq`        | 返回编译成功状态                         | 🔲   |          |      |
| L4-07 | 错误代码编译        | `isq_compile` 对含语法错误的 `.isq` 文件 | 返回结构化编译错误信息（行号、错误类型） | 🔲   |          |      |
| L4-08 | 量子模拟            | `isq_simulate` 对 Bell State 代码        | 返回概率分布（\|00⟩和\|11⟩各约 50%）     | 🔲   |          |      |
| L4-09 | 模拟结果可视化      | 查看 `isq_simulate` 的格式化输出         | 包含 ASCII 概率条形图                    | 🔲   |          |      |
| L4-10 | Docker 容器生命周期 | 编译/模拟操作前后检查容器状态            | 操作完成后容器正确清理                   | 🔲   |          |      |

## 4.4.3 isqtools 调用链 (P2)

| 编号  | 测试项                | 验证方法                                              | 预期结果                               | 状态 | 实际结果 | 备注 |
| ----- | --------------------- | ----------------------------------------------------- | -------------------------------------- | ---- | -------- | ---- |
| L4-11 | Python + isQ 联合执行 | `isqtools_run` 执行含 `isqtools.run()` 的 Python 脚本 | Python 调用 isQ 编译并返回结果         | 🔲   |          |      |
| L4-12 | isQ 文件自动发现      | `isqtools_run` 带 `isq_files` 参数                    | 指定的 `.isq` 文件被注入到 Docker 容器 | 🔲   |          |      |
| L4-13 | 执行超时              | `isqtools_run` 执行耗时超长的代码                     | 超时后优雅终止，返回超时错误           | 🔲   |          |      |
| L4-14 | 沙箱隔离              | `isqtools_run` 中尝试访问宿主文件系统                 | 被 Docker 沙箱阻止，无法越权访问       | 🔲   |          |      |

## 4.4.4 自动修复循环 (P3)

| 编号  | 测试项                          | 验证方法                                     | 预期结果                                    | 状态 | 实际结果 | 备注 |
| ----- | ------------------------------- | -------------------------------------------- | ------------------------------------------- | ---- | -------- | ---- |
| L4-15 | isQ 编译自动修复                | `isq_auto_fix` 对含简单错误的 isQ 代码       | 返回修复后的代码和修复说明                  | 🔲   |          |      |
| L4-16 | isqtools 自动修复 — 编译错误    | `isqtools_auto_fix` 对 isQ 编译错误          | 分类为 `isq_compile`，调用 multi-agent 修复 | 🔲   |          |      |
| L4-17 | isqtools 自动修复 — Python 错误 | `isqtools_auto_fix` 对 Python 运行时错误     | 分类为 `python_runtime`，返回结构化诊断     | 🔲   |          |      |
| L4-18 | isqtools 自动修复 — API 错误    | `isqtools_auto_fix` 对 isqtools API 用法错误 | 分类为 `isqtools_api`，返回 RAG 检索结果    | 🔲   |          |      |
| L4-19 | isqtools 自动修复 — 超时        | `isqtools_auto_fix` 对超时错误               | 分类为 `timeout`，立即中止                  | 🔲   |          |      |

## 4.4.5 RAG 知识检索 (P3)

| 编号  | 测试项        | 验证方法                                | 预期结果                              | 状态 | 实际结果 | 备注 |
| ----- | ------------- | --------------------------------------- | ------------------------------------- | ---- | -------- | ---- |
| L4-20 | 知识搜索      | `isq_rag_search` 搜索 "Bell State"      | 返回相关文档片段（97 篇文档库中检索） | 🔲   |          |      |
| L4-21 | 中文查询      | `isq_rag_search` 搜索 "量子纠缠"        | 返回中文相关内容                      | 🔲   |          |      |
| L4-22 | 空结果处理    | `isq_rag_search` 搜索无关关键词         | 返回空结果或低置信度提示              | 🔲   |          |      |
| L4-23 | Qdrant 不可用 | 在 Qdrant 未启动时调用 `isq_rag_search` | 返回友好错误信息，不崩溃              | 🔲   |          |      |

## 4.4.6 快速路径 & 规则 (P3)

| 编号  | 测试项       | 验证方法                         | 预期结果                             | 状态 | 实际结果 | 备注 |
| ----- | ------------ | -------------------------------- | ------------------------------------ | ---- | -------- | ---- |
| L4-24 | 模板匹配     | `isq_fast_path` 请求 "bell" 模板 | 返回 Bell State 代码模板，0 LLM 调用 | 🔲   |          |      |
| L4-25 | 所有模板覆盖 | 逐一测试 11 个快速路径模板       | 所有模板均返回正确代码               | 🔲   |          |      |
| L4-26 | 规则查询     | `isq_rules_query` 查询已有规则   | 返回规则列表                         | 🔲   |          |      |

## 4.4.7 LLM 集成 (P2)

| 编号  | 测试项          | 验证方法                                   | 预期结果                             | 状态 | 实际结果 | 备注 |
| ----- | --------------- | ------------------------------------------ | ------------------------------------ | ---- | -------- | ---- |
| L4-27 | Gemini API 对话 | 使用 `GEMINI_API_KEY` 发送对话请求         | 流式返回响应，含量子计算上下文       | 🔲   |          |      |
| L4-28 | Zhipu GLM 对话  | 使用 `ZHIPU_API_KEY` 发送对话请求          | 流式返回响应（SSE），工具调用正常    | 🔲   |          |      |
| L4-29 | Zhipu 工具调用  | 通过 Zhipu 触发 MCP 工具                   | 工具参数正确传递，结果正确返回给模型 | 🔲   |          |      |
| L4-30 | LLM 切换        | 从 Gemini 切换到 Zhipu（更换环境变量重启） | 两者均可正常驱动完整工作流           | 🔲   |          |      |

## 4.4.8 继承功能回归

| 编号  | 测试项                     | 执行命令                                  | 预期结果                | 状态 | 实际结果 | 备注 |
| ----- | -------------------------- | ----------------------------------------- | ----------------------- | ---- | -------- | ---- |
| L4-31 | 集成测试套件 — 无沙箱      | `npm run test:integration:sandbox:none`   | 所有继承的集成测试通过  | 🔲   |          |      |
| L4-32 | 集成测试套件 — Docker 沙箱 | `npm run test:integration:sandbox:docker` | 所有继承的集成测试通过  | 🔲   |          |      |
| L4-33 | E2E 测试套件               | `npm run test:e2e`                        | 所有继承的 E2E 测试通过 | 🔲   |          |      |

---

## 测试结果汇总

| 子模块          | 用例数 | 通过 | 失败 | 跳过 |
| --------------- | ------ | ---- | ---- | ---- |
| MCP Server 连接 | 5      |      |      |      |
| isQ 编译 & 模拟 | 5      |      |      |      |
| isqtools 调用链 | 4      |      |      |      |
| 自动修复循环    | 5      |      |      |      |
| RAG 知识检索    | 4      |      |      |      |
| 快速路径 & 规则 | 3      |      |      |      |
| LLM 集成        | 4      |      |      |      |
| 继承功能回归    | 3      |      |      |      |
| **合计**        | **33** |      |      |      |

**通过率:** _/33 ( _%)

---

## 阻塞问题记录

| #   | 问题描述 | 影响范围 | 严重程度 | 状态 |
| --- | -------- | -------- | -------- | ---- |
|     |          |          |          |      |

---

## 签字确认

- **测试执行人:** \***\*\_\_\_\_\*\***
- **完成日期:** \***\*\_\_\_\_\*\***
- **结论:** ☐ 全部通过，可进入 Phase 5 / ☐ 存在阻塞问题，需修复后重测
